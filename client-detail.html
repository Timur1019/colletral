<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corporative - Client Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/forms.css">
    <link rel="stylesheet" href="styles/bootstrap-overrides.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1 class="logo">Corporate collection</h1>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <h3 class="nav-section-title">Monitoring</h3>
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a href="index.html" class="nav-link">
                                <i class="fas fa-home"></i>
                                <span>Home</span>
                            </a>
                        </li>
                        <li class="nav-item active">
                            <a href="clients.html" class="nav-link">
                                <i class="fas fa-users"></i>
                                <span>Clients</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="workouts.html" class="nav-link">
                                <i class="fas fa-chart-line"></i>
                                <span>Workouts</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="regions.html" class="nav-link">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>Regions</span>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <div class="nav-section">
                    <h3 class="nav-section-title">Access Controls</h3>
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-users"></i>
                                <span>Users</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-shield-alt"></i>
                                <span>Roles</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-info">
                        <div class="user-name">admin</div>
                        <div class="user-role">Regular User</div>
                    </div>
                    <button class="notification-btn">
                        <i class="fas fa-bell"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="content-header">
                <div class="header-left">
                    <button class="btn-back" onclick="window.history.back()">
                        <i class="fas fa-arrow-left"></i>
                        <span>Back</span>
                    </button>
                    <h1 class="page-header-title">Client</h1>
                </div>
                <div class="header-right">
                    <div class="breadcrumbs">
                        <i class="fas fa-home"></i>
                        <span class="breadcrumb-separator">/</span>
                        <span>home</span>
                        <span class="breadcrumb-separator">/</span>
                        <span id="breadcrumb-client">Client</span>
                    </div>
                    <div class="header-actions">
                        <div class="language-selector-dropdown">
                            <img src="https://flagcdn.com/w20/us.png" alt="EN" class="flag-icon">
                            <span class="lang active">EN</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <button class="icon-btn notification-btn-header">
                            <i class="fas fa-bell"></i>
                        </button>
                        <button class="icon-btn lightbulb-btn">
                            <i class="fas fa-lightbulb"></i>
                        </button>
                        <div class="user-profile-header">
                            <div class="user-avatar-header">
                                <span>RT</span>
                            </div>
                            <span class="user-name-header">Raximbardiyev Temur</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Body -->
            <div class="content-body">
                <!-- Client Header -->
                <div class="page-header">
                    <h2 class="page-title" id="client-page-title">Client: "Ko'prikqurilish" tresti unitar korxonasining 13-ko'prikqurilish otryadi</h2>
                </div>

                <!-- Financial Metrics Cards -->
                <div class="metrics-cards-grid" id="client-metrics-cards">
                    <!-- Cards will be populated dynamically -->
                </div>

                <!-- Download Card -->
                <div class="download-card">
                    <div class="download-card-content">
                        <div class="download-icon">
                            <i class="fas fa-download"></i>
                        </div>
                        <div class="download-info">
                            <h4 class="download-title">Download Client Card</h4>
                            <p class="download-subtitle">Export client information</p>
                        </div>
                        <div class="download-actions">
                            <select class="file-format-select">
                                <option value="pdf">PDF</option>
                                <option value="excel">Excel</option>
                                <option value="word">Word</option>
                                <option value="csv">CSV</option>
                            </select>
                            <button class="btn btn-primary btn-download">
                                <i class="fas fa-download"></i>
                                Download
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Client Information Form -->
                <div class="form-section client-questionnaire">
                    <h3 class="section-title">Client Passport</h3>
                    
                    <!-- Three Column Layout -->
                    <div class="questionnaire-columns" id="questionnaire-columns">
                        <!-- Left Column: Information -->
                        <div class="questionnaire-column">
                            <h4 class="column-title">Information</h4>
                            <div class="questionnaire-column-grid">
                                <div class="questionnaire-card">
                                    <label class="questionnaire-label" title="Region Name">Region name</label>
                                    <input type="text" class="questionnaire-input" value="Toshkent" title="Region Name">
                                </div>
                                <div class="questionnaire-card">
                                    <label class="questionnaire-label" title="Group Name">Group name</label>
                                    <input type="text" class="questionnaire-input" value="SOHIB OMAD BARAKASI" title="Group Name">
                                </div>
                                <div class="questionnaire-card">
                                    <label class="questionnaire-label" title="Client Name">
                                        CLIENT NAME <span class="required">*</span>
                                    </label>
                                    <select class="questionnaire-input" id="client-name-select" required title="Client Name">
                                        <option value="">Select client...</option>
                                    </select>
                                </div>
                                <div class="questionnaire-card">
                                    <label class="questionnaire-label" title="Activity Type">Activity Type</label>
                                    <div class="questionnaire-value" id="activity-types-display" title="Activity Type">-</div>
                                </div>
                                <div class="questionnaire-card">
                                    <label class="questionnaire-label" title="Contact Person">Contact Person</label>
                                    <input type="text" class="questionnaire-input" value="Siddiqov Mumin" title="Contact Person">
                                </div>
                                <div class="questionnaire-card">
                                    <label class="questionnaire-label" title="Role">Role</label>
                                    <input type="text" class="questionnaire-input" value="Direktor" title="Role">
                                </div>
                                <div class="questionnaire-card">
                                    <label class="questionnaire-label" title="Contact Number">Contact number</label>
                                    <input type="text" class="questionnaire-input" value="+99888-507-0050" title="Contact Number">
                                </div>
                            </div>
                        </div>

                        <!-- Middle Column: Exposure -->
                        <div class="questionnaire-column">
                            <h4 class="column-title">Exposure</h4>
                            <div class="questionnaire-column-grid">
                                <div class="questionnaire-card">
                                    <label class="questionnaire-label" title="Total Exposure">Total exposure</label>
                                    <div class="questionnaire-value" title="Total Exposure">885 999 000</div>
                                </div>
                                <div class="questionnaire-card">
                                    <label class="questionnaire-label" title="Total Principal Exposure">Total principal exposure</label>
                                    <div class="questionnaire-value" title="Total Principal Exposure">455 655 22</div>
                                </div>
                                <div class="questionnaire-card">
                                    <label class="questionnaire-label" title="Overdue Principal Exposure">Overdue principal exposure</label>
                                    <div class="questionnaire-value" title="Overdue Principal Exposure">954 556 666</div>
                                </div>
                                <div class="questionnaire-card">
                                    <label class="questionnaire-label" title="Total Interest Exposure">Total interest exposure</label>
                                    <div class="questionnaire-value" title="Total Interest Exposure">122 545 555</div>
                                </div>
                                <div class="questionnaire-card">
                                    <label class="questionnaire-label" title="Overdue Interest">Overdue interest</label>
                                    <div class="questionnaire-value" title="Overdue Interest">15 455 222</div>
                                </div>
                                <div class="questionnaire-card">
                                    <label class="questionnaire-label" title="Penalties">Penalties</label>
                                    <div class="questionnaire-value" title="Penalties">0</div>
                                </div>
                                <div class="questionnaire-card">
                                    <label class="questionnaire-label" title="Days Past Due">DPD (Days Past Due)</label>
                                    <div class="questionnaire-value" title="Days Past Due">650</div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Responsible -->
                        <div class="questionnaire-column">
                            <h4 class="column-title">Responsible</h4>
                            <div class="questionnaire-column-grid">
                                <!-- Responsible Stage 1 -->
                                <div class="responsible-card">
                                    <h5 class="responsible-title-small">Responsible stage 1</h5>
                                    <div class="responsible-fields">
                                        <input type="text" class="questionnaire-input" placeholder="F.I.O." value="">
                                        <input type="text" class="questionnaire-input" placeholder="Nomer contakt" value="">
                                        <input type="email" class="questionnaire-input" placeholder="email ipoteka" value="">
                                    </div>
                                </div>

                                <!-- Responsible Stage 2 -->
                                <div class="responsible-card">
                                    <h5 class="responsible-title-small">Responsible stage 2</h5>
                                    <div class="responsible-fields">
                                        <input type="text" class="questionnaire-input" placeholder="F.I.O." value="">
                                        <input type="text" class="questionnaire-input" placeholder="Nomer contakt" value="">
                                        <input type="email" class="questionnaire-input" placeholder="email ipoteka" value="">
                                    </div>
                                </div>

                                <!-- Responsible Stage 3 (Grouped) -->
                                <div class="responsible-card responsible-card-grouped">
                                    <h5 class="responsible-title-grouped">Responsible stage 3</h5>
                                    <div class="responsible-grouped-content">
                                    <!-- Responsible Economist -->
                                    <div class="responsible-subsection">
                                        <h6 class="responsible-subtitle">Responsible Economist</h6>
                                        <div class="responsible-fields">
                                                <input type="text" class="questionnaire-input" placeholder="F.I.O." value="">
                                                <input type="text" class="questionnaire-input" placeholder="Nomer contakt" value="">
                                                <input type="email" class="questionnaire-input" placeholder="email ipoteka" value="">
                                        </div>
                                    </div>

                                    <!-- Responsible Legal -->
                                    <div class="responsible-subsection">
                                        <h6 class="responsible-subtitle">Responsible Legal</h6>
                                        <div class="responsible-fields">
                                                <input type="text" class="questionnaire-input" placeholder="F.I.O." value="">
                                                <input type="text" class="questionnaire-input" placeholder="Nomer contakt" value="">
                                                <input type="email" class="questionnaire-input" placeholder="email ipoteka" value="">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- View Detailed Information Button -->
                    <div class="questionnaire-actions">
                        <button class="btn btn-primary btn-view-details" onclick="openQuestionnaireModal()">
                            <i class="fas fa-eye"></i>
                            Посмотреть детальную информацию
                        </button>
                    </div>
                </div>

                <!-- Questionnaire Modal -->
                <div class="modal fade" id="questionnaire-modal" tabindex="-1" aria-labelledby="questionnaireModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                        <div class="modal-header">
                                <h5 class="modal-title" id="questionnaireModalLabel">Client Passport - Detailed Information</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="questionnaire-modal-body">
                            <!-- Content will be populated from questionnaire -->
                        </div>
                        <div class="modal-footer">
                                <select class="form-select" id="modal-format-select" style="width: auto;">
                                <option value="pdf">PDF</option>
                                <option value="excel">Excel</option>
                                <option value="word">Word</option>
                                <option value="csv">CSV</option>
                            </select>
                                <button type="button" class="btn btn-primary" onclick="downloadQuestionnaire()">
                                <i class="fas fa-download"></i>
                                Download Document
                            </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="loans-tab-btn" data-bs-toggle="tab" data-bs-target="#loans-tab" type="button" role="tab">Loans</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="legal-cases-tab-btn" data-bs-toggle="tab" data-bs-target="#legal-cases-tab" type="button" role="tab">Legal cases</button>
                    </li>
                </ul>

                <!-- Tab Content Container -->
                <div class="tab-content">
                    <!-- Loans Tab Content -->
                    <div class="tab-pane fade show active" id="loans-tab" role="tabpanel">
                        <div class="tab-header">
                            <h3 class="section-title">Loans</h3>
                        </div>

                        <!-- Group Clients Section -->
                        <div id="group-clients-section" class="group-clients-section">
                            <h3 class="section-title" id="group-clients-title">Group: SOHIB OMAD BARAKASI</h3>
                            
                            <div class="table-container">
                                <div class="table-wrapper">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>No.</th>
                                                <th>Region name</th>
                                                <th>Group name</th>
                                                <th>Client name</th>
                                                <th>NIBBD</th>
                                                <th>Local Exposure</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="group-clients-table-body">
                                            <!-- Динамически заполняется через JavaScript -->
                                        </tbody>
                                    </table>
                                    </div>
                                </div>
                        </div>
                    </div>

                    <!-- Legal Cases Tab Content -->
                    <div class="tab-pane fade" id="legal-cases-tab" role="tabpanel">
                        <div class="tab-header">
                            <h3 class="section-title">Legal cases</h3>
                            <button class="btn btn-primary">
                                <i class="fas fa-plus"></i>
                                Add
                            </button>
                        </div>

                        <div class="table-container">
                            <div class="table-wrapper">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>No.</th>
                                            <th>Legal case</th>
                                            <th>Documents</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>1</td>
                                            <td>Legal case</td>
                                            <td>
                                                <span class="badge badge-info">2</span>
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="btn btn-sm btn-outline-primary" title="View">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>2</td>
                                            <td>Legal case</td>
                                            <td>
                                                <span class="badge badge-info">0</span>
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="btn btn-sm btn-outline-primary" title="View">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="table-footer">
                                <div class="table-info">
                                    <a href="#" class="link">Configure columns</a>
                                    <span class="records-info">Displayed records: 1-2 of 2</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Footer -->
            <footer class="content-footer">
                <p>The application code is published under the MIT license. 2025 - 2025</p>
                <p>Version: 1.0.0</p>
            </footer>
        </main>
    </div>

    <script src="scripts/main.js"></script>
    <script src="scripts/tabs.js"></script>
    <script>
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const groupName = urlParams.get('group');
        const clientParam = urlParams.get('client');
        
        // Check if current client belongs to a group
        let currentClientName = document.getElementById('breadcrumb-client').textContent;
        
        // Данные клиентов для отображения на странице (расширенный список)
        const allClientNames = {
            '"Ko\'prikqurilish" tresti unitar korxonasining 13-ko\'prikqurilish otryadi': {
                name: '"Ko\'prikqurilish" tresti unitar korxonasining 13-ko\'prikqurilish otryadi',
                region: 'Toshkent',
                activityType: 'Qurilish',
                contactPerson: 'Qurilish Menejeri',
                role: 'Direktor',
                contactNumber: '+99888-507-0050'
            }
        };
        
        // Данные клиентов для отображения на странице
        const clientDetailsData = {
            'SOHIB OMAD BARAKASI': {
                name: 'SOHIB OMAD BARAKASI',
                region: 'Toshkent',
                activityType: 'Klasster',
                contactPerson: 'Siddiqov Mumin',
                role: 'Direktor',
                contactNumber: '+99888-507-0050'
            },
            'ООО "BEST TEXTILE INTERNATIONAL"': {
                name: 'ООО "BEST TEXTILE INTERNATIONAL"',
                region: 'Qoraqalpog\'iston',
                activityType: 'Tekstil',
                contactPerson: 'Ivanov Ivan',
                role: 'Direktor',
                contactNumber: '+99890-123-4567'
            },
            'Euro Global Invest': {
                name: 'Euro Global Invest',
                region: 'Samarqand',
                activityType: 'Investitsiya',
                contactPerson: 'Petrov Petr',
                role: 'Direktor',
                contactNumber: '+99891-234-5678'
            },
            'ООО "EURO GLOBAL INVEST"': {
                name: 'ООО "EURO GLOBAL INVEST"',
                region: 'Sirdaryo',
                activityType: 'Investitsiya',
                contactPerson: 'Sidorov Sidor',
                role: 'Direktor',
                contactNumber: '+99892-345-6789'
            },
            'Statiska HOMS': {
                name: 'Statiska HOMS',
                region: 'Toshkent',
                activityType: 'Klasster',
                contactPerson: 'Siddiqov Mumin',
                role: 'Direktor',
                contactNumber: '+99888-507-0050'
            }
        };
        
        // Map clients to groups - определяем к какой группе принадлежит клиент
        const groupMapping = {
            'SOHIB OMAD BARAKASI': 'SOHIB OMAD BARAKASI',
            'ООО "BEST TEXTILE INTERNATIONAL"': 'SOHIB OMAD BARAKASI',
            'Statiska HOMS': 'SOHIB OMAD BARAKASI',
            'Euro Global Invest': 'Euro Global Invest',
            'ООО "EURO GLOBAL INVEST"': 'Euro Global Invest',
            'ООО "GLOBAL INVEST BUILD"': 'Euro Global Invest',
            'MCHJ "EURO GLOBAL ASPHALT"': 'Euro Global Invest',
            'ООО "ELITE KONSTRUKTION OPTIMA"': 'Euro Global Invest',
            '"Ko\'prikqurilish" tresti unitar korxonasining 13-ko\'prikqurilish otryadi': '"Ko\'prikqurilish" tresti unitar korxonasining 13-ko\'prikqurilish otryadi',
            'ООО "SIYOVUSH TEKSTIL BUXORO"': 'ООО SIYOVUSH TEKSTIL BUXORO',
            'ООО "AGRO TRADE"': 'Agro Trade',
            'ООО "EXIM AGRO LOGISTIC"': 'Agro Trade',
            '"OLTIN MATO-GROUP" МЧЖ': 'OLTIN MATO-GROUP',
            'ORIENT- CERAMIC МЧЖ': 'OLTIN MATO-GROUP',
            '"ORIENT- CERAMIC" МЧЖ': 'OLTIN MATO-GROUP',
            'ООО "MODERNA CEMENT"': 'OLTIN MATO-GROUP'
        };
        
        // Данные о клиентах в группах - все кредитные линии всех клиентов группы
        const groupClientsData = {
            'SOHIB OMAD BARAKASI': [
                { name: 'SOHIB OMAD BARAKASI', mfo: '00978', region: 'Toshkent', nibbd: '175464', loan: '130 000 000 000,00', status: 'off' },
                { name: 'SOHIB OMAD BARAKASI', mfo: '00408', region: 'Andijon', nibbd: '190917', loan: '200 000 000 000,00', status: 'on' },
                { name: 'ООО "BEST TEXTILE INTERNATIONAL"', mfo: '00544', region: 'Qoraqalpog\'iston', nibbd: '223160', loan: '150 000 000 000,00', status: 'on' }
            ],
            'Euro Global Invest': [
                { name: 'Euro Global Invest', mfo: '01076', region: 'Samarqand', nibbd: '229035', loan: '300 000 000 000,00', status: 'on' },
                { name: 'ООО "EURO GLOBAL INVEST"', mfo: '00122', region: 'Sirdaryo', nibbd: '236366', loan: '250 000 000 000,00', status: 'on' }
            ],
            '"Ko\'prikqurilish" tresti unitar korxonasining 13-ko\'prikqurilish otryadi': [
                { name: '"Ko\'prikqurilish" tresti unitar korxonasining 13-ko\'prikqurilish otryadi', loanId: '97800001896770', currency: 'UZS', loanNominal: '130 000 000 000,00', loanUzs: '130 000 000 000,00', status: 'off', region: '1-Худуд' }
            ]
        };
        
        // Функция для обновления данных клиента на странице
        function updateClientData(clientName) {
            if (!clientName) {
                console.log('Client name is empty');
                return;
            }
            
            console.log('=== Updating client data for:', clientName, '===');
            
            // Сначала проверяем в clientDetailsData, потом в allClientNames
            let clientData = clientDetailsData[clientName] || allClientNames[clientName];
            
            // Если данных нет, создаем предварительные данные из имени клиента
            if (!clientData) {
                console.log('Client data not found, using default data for:', clientName);
                // Определяем регион по имени клиента или используем дефолтный
                let region = 'Toshkent';
                let activityType = 'Klasster';
                
                // Попытка определить регион из данных группы
                const group = groupMapping[clientName];
                if (group && groupClientsData[group]) {
                    const clientInGroup = groupClientsData[group].find(c => c.name === clientName);
                    if (clientInGroup) {
                        region = clientInGroup.region;
                        console.log('Found region from group data:', region);
                    }
                }
                
                clientData = {
                    name: clientName,
                    region: region,
                    activityType: activityType,
                    contactPerson: 'Contact Person',
                    role: 'Direktor',
                    contactNumber: '+99888-507-0050'
                };
            }
            
            console.log('Using client data:', clientData);
            
            // Обновляем breadcrumb
            const breadcrumbClient = document.getElementById('breadcrumb-client');
            if (breadcrumbClient) {
                breadcrumbClient.textContent = clientData.name;
                console.log('✓ Updated breadcrumb to:', clientData.name);
            } else {
                console.error('✗ Breadcrumb element not found!');
            }
            
            // Обновляем заголовок страницы
            const pageTitle = document.getElementById('client-page-title');
            if (pageTitle) {
                pageTitle.textContent = 'Client: ' + clientData.name;
                console.log('✓ Updated page title to:', 'Client: ' + clientData.name);
            } else {
                console.error('✗ Page title element not found!');
            }
            
            // Обновляем поле Client name в форме (теперь это select)
            const clientNameSelect = document.getElementById('client-name-select');
            if (clientNameSelect) {
                clientNameSelect.value = clientData.name;
                console.log('✓ Updated client name select to:', clientData.name);
            } else {
                console.error('✗ Client name select element not found!');
            }
            
            // Обновляем другие поля формы в первой колонке (Information)
            const firstColumn = document.querySelector('.questionnaire-column:first-child');
            if (firstColumn) {
                const inputs = firstColumn.querySelectorAll('.questionnaire-input');
                console.log('Found', inputs.length, 'inputs in first column');
                
                // Region name (первое поле)
                if (inputs[0]) {
                    inputs[0].value = clientData.region;
                    inputs[0].dispatchEvent(new Event('input', { bubbles: true }));
                    inputs[0].dispatchEvent(new Event('change', { bubbles: true }));
                    console.log('✓ Updated region to:', clientData.region);
                }
                
                // Group name (второе поле)
                if (inputs[1]) {
                    const group = groupMapping[clientData.name] || clientData.name;
                    inputs[1].value = group;
                    inputs[1].dispatchEvent(new Event('input', { bubbles: true }));
                    inputs[1].dispatchEvent(new Event('change', { bubbles: true }));
                    console.log('✓ Updated group name to:', group);
                    
                    // Обновляем список клиентов группы и типы деятельности
                    populateClientNameSelect(group);
                }
                
                // Client name (третье поле) - теперь это select, обновлено выше через ID
                
                // Activity type (четвертое поле)
                if (inputs[3]) {
                    inputs[3].value = clientData.activityType;
                    inputs[3].dispatchEvent(new Event('input', { bubbles: true }));
                    inputs[3].dispatchEvent(new Event('change', { bubbles: true }));
                    console.log('✓ Updated activity type to:', clientData.activityType);
                }
                
                // Contact Person (пятое поле)
                if (inputs[4]) {
                    inputs[4].value = clientData.contactPerson;
                    inputs[4].dispatchEvent(new Event('input', { bubbles: true }));
                    inputs[4].dispatchEvent(new Event('change', { bubbles: true }));
                    console.log('✓ Updated contact person to:', clientData.contactPerson);
                }
                
                // Role (шестое поле)
                if (inputs[5]) {
                    inputs[5].value = clientData.role;
                    inputs[5].dispatchEvent(new Event('input', { bubbles: true }));
                    inputs[5].dispatchEvent(new Event('change', { bubbles: true }));
                    console.log('✓ Updated role to:', clientData.role);
                }
                
                // Contact number (седьмое поле)
                if (inputs[6]) {
                    inputs[6].value = clientData.contactNumber;
                    inputs[6].dispatchEvent(new Event('input', { bubbles: true }));
                    inputs[6].dispatchEvent(new Event('change', { bubbles: true }));
                    console.log('✓ Updated contact number to:', clientData.contactNumber);
                }
            } else {
                console.error('✗ First column not found!');
            }
            
            console.log('=== Finished updating client data ===');
            
            // Обновляем текущее имя клиента для дальнейшей работы
            currentClientName = clientData.name;
        }
        
        // Функция для заполнения списка клиентов группы
        function populateClientNameSelect(groupName) {
            const clientSelect = document.getElementById('client-name-select');
            const activityTypesDisplay = document.getElementById('activity-types-display');
            
            if (!clientSelect) return;
            
            // Очищаем select
            clientSelect.innerHTML = '<option value="">Select client...</option>';
            
            if (!groupName || !groupClientsData[groupName]) {
                if (activityTypesDisplay) {
                    activityTypesDisplay.textContent = '-';
                }
                return;
            }
            
            const clients = groupClientsData[groupName];
            const activityTypes = new Set();
            
            // Заполняем select клиентами группы и собираем типы деятельности
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.name;
                option.textContent = client.name;
                clientSelect.appendChild(option);
                
                // Получаем тип деятельности из clientDetailsData
                const clientDetail = clientDetailsData[client.name];
                if (clientDetail && clientDetail.activityType) {
                    activityTypes.add(clientDetail.activityType);
                }
            });
            
            // Обновляем поле Activity Type со всеми типами деятельности
            if (activityTypesDisplay) {
                if (activityTypes.size > 0) {
                    activityTypesDisplay.textContent = Array.from(activityTypes).join(', ');
                } else {
                    activityTypesDisplay.textContent = '-';
                }
            }
            
            // Устанавливаем текущего клиента, если он есть
            if (currentClientName) {
                clientSelect.value = currentClientName;
            }
        }
        
        // Инициализация данных клиента при загрузке страницы
        function initializeClientData() {
            // Если есть параметр client в URL, используем его
            if (clientParam) {
                currentClientName = decodeURIComponent(clientParam);
                updateClientData(currentClientName);
            } else {
                // Иначе обновляем данные текущего клиента из breadcrumb
                const breadcrumbName = document.getElementById('breadcrumb-client').textContent;
                if (breadcrumbName && breadcrumbName.trim()) {
                    updateClientData(breadcrumbName.trim());
                }
            }
            
            // Заполняем список клиентов группы
            const group = groupName || groupMapping[currentClientName];
            if (group) {
                populateClientNameSelect(group);
            }
            
            // Добавляем обработчик изменения select клиента
            const clientSelect = document.getElementById('client-name-select');
            if (clientSelect) {
                clientSelect.addEventListener('change', function() {
                    const selectedClient = this.value;
                    if (selectedClient) {
                        currentClientName = selectedClient;
                        updateClientData(selectedClient);
                        
                        // Обновляем URL без перезагрузки
                        const newUrl = `client-detail.html?client=${encodeURIComponent(selectedClient)}`;
                        window.history.pushState({ client: selectedClient }, '', newUrl);
                    }
                });
            }
        }
        
        
        // Глобальная функция для обработки клика по строке клиента
        window.handleClientRowClick = function(loanId, event) {
            // Не переходим, если кликнули на кнопку действия
            if (event && event.target.closest('.action-buttons')) {
                return;
            }
            
            // Останавливаем всплытие события
            if (event) {
                event.stopPropagation();
            }
            
            if (loanId) {
                // Переходим на страницу деталей займа
                const encodedLoanId = encodeURIComponent(loanId);
                window.location.href = `loan-detail.html?loan=${encodedLoanId}`;
            }
        };
        
        // Вызываем инициализацию при загрузке страницы
        initializeClientData();
        
        // Определяем группу: сначала из URL, потом из маппинга
        const finalGroupName = groupName || groupMapping[currentClientName];
        
        // Заполняем список клиентов группы
        if (finalGroupName) {
            populateClientNameSelect(finalGroupName);
        }
        
        if (finalGroupName && groupClientsData[finalGroupName]) {
            // Update page title if group is in URL
            if (groupName) {
                const pageTitle = document.querySelector('.page-header-title');
                if (pageTitle) {
                    pageTitle.textContent = 'Group: ' + finalGroupName;
                }
            }
            
            // Показываем секцию с клиентами группы в Loans tab
            const groupClientsSection = document.getElementById('group-clients-section');
            if (groupClientsSection) {
                groupClientsSection.style.display = 'block';
            }
            const groupClientsTitle = document.getElementById('group-clients-title');
            if (groupClientsTitle) {
                groupClientsTitle.textContent = 'Group: ' + finalGroupName;
            }
            
            // Заполняем одну таблицу всеми клиентами группы и их кредитными линиями
            const tableBody = document.getElementById('group-clients-table-body');
            if (tableBody) {
            const clients = groupClientsData[finalGroupName];
            
            // Генерируем строки таблицы для всех клиентов группы
            tableBody.innerHTML = clients.map((client, index) => {
                // Используем onclick напрямую в HTML для надежности
                    const loanId = client.loanId || client.mfo || '';
                    const loanIdEscaped = loanId.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `
                <tr class="clickable-row" data-client-name="${client.name.replace(/"/g, '&quot;')}" 
                        onclick="handleClientRowClick('${loanIdEscaped}', event)" 
                    style="cursor: pointer;">
                    <td>${index + 1}</td>
                    <td>${client.region}</td>
                        <td>${finalGroupName}</td>
                    <td class="client-name-cell">${client.name}</td>
                    <td>${client.nibbd}</td>
                    <td>${client.loan}</td>
                    <td><span class="badge badge-${client.status === 'on' ? 'success' : 'secondary'}">${client.status}</span></td>
                    <td>
                        <div class="action-buttons" onclick="event.stopPropagation();">
                                <button class="action-btn edit" title="Edit" onclick="event.stopPropagation(); window.location.href='loan-detail.html?loan=${encodeURIComponent(loanId)}'">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
            }
        }
        
        // Данные финансовых метрик для клиентов
        const clientsMetricsData = {
            'SOHIB OMAD BARAKASI': {
                localExposure: { primary: 562.6, secondary: 515.4, percentage: 92 },
                ifrsExposure: { primary: 279.0, secondary: 259.6, percentage: 93 },
                expectedRecovery: { primary: 257.1, secondary: 239.8, percentage: 93 },
                plan2025: { primary: 300.0, secondary: 280.0, percentage: 93 },
                recovery2025: { primary: 275.0, secondary: 255.0, percentage: 93 }
            },
            'ООО "BEST TEXTILE INTERNATIONAL"': {
                localExposure: { primary: 450.2, secondary: 420.1, percentage: 93 },
                ifrsExposure: { primary: 320.5, secondary: 298.1, percentage: 93 },
                expectedRecovery: { primary: 280.4, secondary: 261.2, percentage: 93 },
                plan2025: { primary: 320.0, secondary: 298.0, percentage: 93 },
                recovery2025: { primary: 295.0, secondary: 275.0, percentage: 93 }
            },
            'Euro Global Invest': {
                localExposure: { primary: 680.3, secondary: 625.9, percentage: 92 },
                ifrsExposure: { primary: 350.8, secondary: 326.2, percentage: 93 },
                expectedRecovery: { primary: 310.2, secondary: 289.5, percentage: 93 },
                plan2025: { primary: 380.0, secondary: 354.0, percentage: 93 },
                recovery2025: { primary: 350.0, secondary: 326.0, percentage: 93 }
            },
            '"Ko\'prikqurilish" tresti unitar korxonasining 13-ko\'prikqurilish otryadi': {
                localExposure: { primary: 620.5, secondary: 570.9, percentage: 92 },
                ifrsExposure: { primary: 310.2, secondary: 288.5, percentage: 93 },
                expectedRecovery: { primary: 290.1, secondary: 270.4, percentage: 93 },
                plan2025: { primary: 340.0, secondary: 317.0, percentage: 93 },
                recovery2025: { primary: 315.0, secondary: 294.0, percentage: 93 }
            },
            'Statiska HOMS': {
                localExposure: { primary: 562.6, secondary: 515.4, percentage: 92 },
                ifrsExposure: { primary: 279.0, secondary: 259.6, percentage: 93 },
                expectedRecovery: { primary: 257.1, secondary: 239.8, percentage: 93 },
                plan2025: { primary: 300.0, secondary: 280.0, percentage: 93 },
                recovery2025: { primary: 275.0, secondary: 255.0, percentage: 93 }
            },
            'default': {
                localExposure: { primary: 500.0, secondary: 460.0, percentage: 92 },
                ifrsExposure: { primary: 250.0, secondary: 232.5, percentage: 93 },
                expectedRecovery: { primary: 240.0, secondary: 223.2, percentage: 93 },
                plan2025: { primary: 280.0, secondary: 260.0, percentage: 93 },
                recovery2025: { primary: 260.0, secondary: 242.0, percentage: 93 }
            }
        };
        
        // Функция для генерации секций кредитных линий группы
        // Функция для генерации карточек метрик
        function generateMetricsCards(containerId, clientName) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const metrics = clientsMetricsData[clientName] || clientsMetricsData['default'];
            
            const cards = [
                {
                    title: 'Local Exposure',
                    icon: 'fa-map-marker-alt',
                    badge: 'LOCAL',
                    primary: metrics.localExposure.primary,
                    secondaryLabel: '>500 000€ Local Exp',
                    secondary: metrics.localExposure.secondary,
                    percentage: metrics.localExposure.percentage
                },
                {
                    title: 'IFRS Exposure',
                    icon: 'fa-globe',
                    badge: 'IFRS',
                    primary: metrics.ifrsExposure.primary,
                    secondaryLabel: '>500 000€ IFRS Exp',
                    secondary: metrics.ifrsExposure.secondary,
                    percentage: metrics.ifrsExposure.percentage
                },
                {
                    title: 'Expected Recovery',
                    icon: 'fa-money-bill-wave',
                    badge: 'EXP',
                    primary: metrics.expectedRecovery.primary,
                    secondaryLabel: '>500 000€ Exp Rec',
                    secondary: metrics.expectedRecovery.secondary,
                    percentage: metrics.expectedRecovery.percentage
                },
                {
                    title: 'Plan 2025',
                    icon: 'fa-calendar-check',
                    badge: 'PLAN',
                    primary: metrics.plan2025.primary,
                    secondaryLabel: '>500 000€ Plan',
                    secondary: metrics.plan2025.secondary,
                    percentage: metrics.plan2025.percentage
                },
                {
                    title: 'Recovery 2025',
                    icon: 'fa-chart-line',
                    badge: 'REC2025',
                    primary: metrics.recovery2025.primary,
                    secondaryLabel: '>500 000€ Rec2025',
                    secondary: metrics.recovery2025.secondary,
                    percentage: metrics.recovery2025.percentage
                }
            ];
            
            container.innerHTML = cards.map((card, index) => {
                const formattedValue = card.primary.toFixed(1).replace('.', ',');
                return `
                <div class="metric-card-dashboard">
                    <div class="metric-card-dashboard-header">
                        <div class="metric-card-dashboard-icon">
                            <i class="fas ${card.icon}"></i>
                        </div>
                        <div class="metric-card-dashboard-title">${card.title}</div>
                    </div>
                    <div class="metric-card-dashboard-value">${formattedValue} млн</div>
                    <div class="metric-card-dashboard-progress">
                        <div class="metric-card-dashboard-progress-bar" style="width: ${card.percentage}%"></div>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        // Обновляем функцию updateClientData для обновления карточек метрик
        const originalUpdateClientData = updateClientData;
        updateClientData = function(clientName) {
            originalUpdateClientData(clientName);
            
            // Обновляем карточки метрик
            const container = document.getElementById('client-metrics-cards');
            if (container) {
                generateMetricsCards('client-metrics-cards', clientName);
            }
        };
        
        // Генерируем карточки при загрузке страницы
        if (document.getElementById('client-metrics-cards')) {
            const initialClientName = document.getElementById('breadcrumb-client').textContent;
            generateMetricsCards('client-metrics-cards', initialClientName);
        }

        // Add hover info to questionnaire cards
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.questionnaire-card');
            cards.forEach(card => {
                const label = card.querySelector('.questionnaire-label');
                const input = card.querySelector('.questionnaire-input');
                const value = card.querySelector('.questionnaire-value');
                
                if (label && (input || value)) {
                    const labelText = label.textContent.trim();
                    const contentText = input ? input.value : (value ? value.textContent.trim() : '');
                    card.setAttribute('data-hover-info', `${labelText}: ${contentText}`);
                }
            });
        });

        // Open Questionnaire Modal
        function openQuestionnaireModal() {
            const modalElement = document.getElementById('questionnaire-modal');
            const modalBody = document.getElementById('questionnaire-modal-body');
            const questionnaireColumns = document.getElementById('questionnaire-columns');
            
            if (modalElement && modalBody && questionnaireColumns) {
                // Clone the questionnaire content
                const clonedContent = questionnaireColumns.cloneNode(true);
                modalBody.innerHTML = '';
                modalBody.appendChild(clonedContent);
                
                // Make all inputs read-only in modal
                const inputs = modalBody.querySelectorAll('input, textarea');
                inputs.forEach(input => {
                    input.readOnly = true;
                    input.style.background = '#f9fafb';
                    input.style.cursor = 'default';
                });
                
                // Show Bootstrap modal
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            }
        }

        // Close Questionnaire Modal
        function closeQuestionnaireModal(event) {
            const modalElement = document.getElementById('questionnaire-modal');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                    modal.hide();
                }
            }
        }

        // Download Questionnaire Document
        function downloadQuestionnaire() {
            const format = document.getElementById('modal-format-select').value;
            const modalBody = document.getElementById('questionnaire-modal-body');
            
            if (!modalBody) return;
            
            // Get all questionnaire data
            const clientName = document.getElementById('client-name-select')?.value || 'Unknown Client';
            
            // Create document content
            let content = `CLIENT QUESTIONNAIRE\n`;
            content += `========================\n\n`;
            content += `Client Name: ${clientName}\n`;
            content += `Generated: ${new Date().toLocaleString()}\n\n`;
            content += `========================\n\n`;
            
            // Get all fields from modal
            const cards = modalBody.querySelectorAll('.questionnaire-card');
            cards.forEach(card => {
                const label = card.querySelector('.questionnaire-label')?.textContent.trim();
                const input = card.querySelector('.questionnaire-input');
                const value = card.querySelector('.questionnaire-value');
                const fieldValue = input ? input.value : (value ? value.textContent.trim() : '');
                
                if (label && fieldValue) {
                    content += `${label}: ${fieldValue}\n`;
                }
            });
            
            // Get responsible persons
            const responsibleCards = modalBody.querySelectorAll('.responsible-card');
            if (responsibleCards.length > 0) {
                content += `\n========================\n`;
                content += `RESPONSIBLE PERSONS\n`;
                content += `========================\n\n`;
                
                responsibleCards.forEach(card => {
                    const title = card.querySelector('.responsible-title-small, .responsible-title')?.textContent.trim();
                    if (title) {
                        content += `${title}\n`;
                    }
                    
                    const fields = card.querySelectorAll('.responsible-field');
                    fields.forEach(field => {
                        const label = field.querySelector('.questionnaire-label')?.textContent.trim();
                        const input = field.querySelector('.questionnaire-input');
                        const fieldValue = input ? input.value : '';
                        
                        if (label && fieldValue) {
                            content += `  ${label}: ${fieldValue}\n`;
                        }
                    });
                    content += `\n`;
                });
            }
            
            // Create download based on format
            const filename = `${clientName.replace(/[^a-zA-Z0-9]/g, '_')}_Questionnaire`;
            
            if (format === 'pdf') {
                // For PDF, we would typically use a library like jsPDF
                // For now, create a text file
                downloadAsFile(content, `${filename}.txt`, 'text/plain');
            } else if (format === 'excel' || format === 'csv') {
                // Convert to CSV format
                let csvContent = 'Field,Value\n';
                const lines = content.split('\n');
                lines.forEach(line => {
                    if (line.includes(':')) {
                        const [field, ...valueParts] = line.split(':');
                        csvContent += `"${field.trim()}","${valueParts.join(':').trim()}"\n`;
                    }
                });
                downloadAsFile(csvContent, `${filename}.csv`, 'text/csv');
            } else if (format === 'word') {
                downloadAsFile(content, `${filename}.txt`, 'text/plain');
            }
        }

        // Helper function to download file
        function downloadAsFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Close modal on Escape key (Bootstrap handles this automatically, but keeping for compatibility)
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('questionnaire-modal');
                if (modal && modal.classList.contains('show')) {
                    closeQuestionnaireModal();
                }
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

